<!DOCTYPE html>
<html lang="en" dir="ltr"
  prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">

<head>
  <title>Automate.Insights Part 2; Practical deep dive (standalone) | Home</title>
  <link type="text/css" rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.0.2/css/bootstrap.min.css"
    media="all" />
</head>

<body role="document" class="html not-front not-logged-in one-sidebar sidebar-first page-node page-node- ">
  <div class="main-container container">
    <header role="banner" id="page-header">
      <div class="region region-header">
        <section id="block-block-1" class="block block-block clearfix">
          <p>
            <img alt="" src="/_merged_assets/_static/images/datafundamentals250simplici.gif"
              style="height: 42px; width: 250px" /><img alt="" src="/_merged_assets/_static/images/whiteBanner.jpg"
              style="height: 42px; width: 43px" /><a href="/content/dev-offerings"><img alt=""
                src="/_merged_assets/_static/images/peteBanner.jpg" /></a><a href="/content/ops-offerings"><img alt=""
                src="/_merged_assets/_static/images/opsJeffBanner.jpg" /></a><a href="/content/df.lab"><img alt=""
                src="/_merged_assets/_static/images/scienceBanner.jpg" /></a><a href="/content/unicorn-gap"><img alt=""
                src="/_merged_assets/_static/images/unicornGapBanner.jpg"
                style="border-style: solid; border-width: 0px" /></a>
          </p>
        </section>
      </div>
    </header>
    <!-- /#page-header -->

    <div class="row">
      <aside class="col-sm-3" role="complementary">
        <div class="region region-sidebar-first well">
          <section id="block-system-navigation" class="block block-system block-menu clearfix">
            <h2 class="block-title">pre2015 Content</h2>

            <ul class="menu nav">
              <li class="first leaf">
                <a href="/content/jeff-on-ops-blog" title="">2014 Jeff on Ops Blog</a>
              </li>
              <li class="last leaf">
                <a href="/content/wins-and-losses" title="">Wins & Losses 2000-2014</a>
              </li>
            </ul>
            <h2 class="block-title">Back</h2>

            <ul class="menu nav">
              <li class="first leaf">
                <a href="/pre2015/" title="">Back to pre2015 Home</a>
              </li>
              <li class="last leaf">
                <a href="/" title="">dataFundamentals.com Home</a>
              </li>
            </ul>
          </section>
        </div>
      </aside>
      <!-- /#sidebar-first -->

      <section class="col-sm-9">
        <a id="main-content"></a>
        <h1 class="page-header">Automate.Insights Part 2; Practical deep dive (standalone) </h1>
        <article id="node-80" class="node node-jeff-on-ops-blog-article clearfix"
          about="/content/automateinsights-part-2-practical-deep-dive-standalone" typeof="sioc:Item foaf:Document">
          <header>
            <span property="dc:title" content="Automate.Insights Part 2; Practical deep dive (standalone) "
              class="rdf-meta element-hidden"></span> <span class="submitted">
              <div class="user-picture">
                <img typeof="foaf:Image" class="img-responsive"
                  src="/_merged_assets/_static/images/picture-11-1400705926-itok=KFQI6U-7.jpg"
                  alt="Jeff Carapetyan&#039;s picture" title="Jeff Carapetyan&#039;s picture" />
              </div>
              <span property="dc:date dc:created" content="2015-07-23T22:26:01-05:00" datatype="xsd:dateTime"
                rel="sioc:has_creator">Submitted by <span class="username" xml:lang="" about="/users/jeff-carapetyan"
                  typeof="sioc:UserAccount" property="foaf:name" datatype="">Jeff Carapetyan</span> on Thu, 07/23/2015 -
                22:26</span>
            </span>
          </header>
          <div class="field field-name-body field-type-text-with-summary field-label-hidden">
            <div class="field-items">
              <div class="field-item even" property="content:encoded">
                <p><em>This is part 2 in a three part blog series. To jump to either one of the other posts, click the
                    links below</em></p>
                <ul>
                  <li><a href="/content/automateinsights-part-1-general-overview"><em>Automate.Insights Part 1; General
                        Overview</em></a></li>
                  <li><a href="/content/automateinsights-part-3-practical-deep-dive-clustered"><em>Automate.insights Part 3;
                        Practical deep dive (clustered)</em></a></li>
                </ul>
                <p><img alt="" src="/_merged_assets/_static/images/07/IMG_9993.jpg" style="height:304px; width:500px" /></p>
                <p>In my previous post, I talked broad strokes in regards to <a
                    href="http://www.thirdwaveinsights.com/automate-insights/"><strong>Automate.Insights</strong></a>
                  and what it's potential application could be for a software team. Here, I am going to get a little bit
                  more in depth in regards to how it is used. </p>
                <p>I decided to try spinning up an ELK (elasticsearch, logstash, kibana) stack to show the capabilities
                  Automate.Insight's  tools themselves. There is a <a
                    href="https://github.com/rackspace-cookbooks/elkstack" style="line-height: 1.6;">strong community
                    cookbook available</a>, but for the simplistic purposes of this setup I decided to write my own
                  standalone cookbooks. Let's get started. </p>
                <h3><strong>Prerequisites </strong></h3>
                <ul>
                  <li><strong>Workstation with 12 GB ram or greater (or adjust memory allocation in
                      Vagrantfile)</strong></li>
                  <li><strong>ChefDK (0.6.0 or later) </strong></li>
                  <li><strong>vagrant</strong></li>
                  <li><strong>virtualbox</strong></li>
                  <li><strong>Basic understanding of Chef</strong></li>
                  <li><a href="http://github.com/datafundamentals/ai-elkstack-repo"><strong>dummy
                        chef-repo </strong></a></li>
                  <li><strong><a href="https://github.com/christinedraper/knife-topo">knife-topo</a> plugin
                      installed </strong></li>
                </ul>
                <p> </p>
                <p>For the sake of this walk-through, you can download a tutorial repo from our github repo. I have
                  included a Vagrantfile, along with a dummy knife.rb to use with a chef-zero server.</p>
                <p>First, you will want to spin up your vagrant instance(s). This will spin up 3 Ubuntu 14.04 instances
                  on your machine configured to a private ip address. You will only need the first server
                  (ai-elkstack-1, ipaddress: 10.0.1.2) for a standalone elkstack, so you can specify just that one if
                  you would like.  </p>
                <pre>
vagrant up </pre>
                <p>Next, to spin up a chef-zero server on your workstation, simply run.</p>
                <pre>
chef-zero -d -H10.0.1.1 </pre>
                <p>This will run a chef-zero server as a background process on your workstation. If you need to kill
                  that chef-zero server later, you will need to run </p>
                <pre>
ps aux | grep chef-zero </pre>
                <p>and kill the listed process id for the chef-zero server</p>
                <p>Next, you will need to pull your cookbook dependencies in and upload them to the chef-server. I have
                  included a Berksfile in the repo that will allow you to pull in dependencies. To pull and upload, run 
                </p>
                <pre>
berks vendor
knife cookbook upload --all --cookbook-path berks-cookbooks/</pre>
                <p>This should give you all the cookbooks that you need. </p>
                <p>If you try to run knife cookbook upload without specifying the cookbook path, you will get several
                  errors saying that it cannot find the cookbooks. This is because the default cookbooks path is
                  cookbooks/, and they don't exist there. If you follow the procedure above you will not encounter these
                  errors.</p>
                <p><strong>Standalone Server</strong></p>
                <p>For this, we are going to show an example of a elk server piping syslogs to the elasticsearch server
                  for processing. </p>
                <p>First, you will want to spin up an elkstack using the cookbooks from our dummy repo. </p>
                <pre>
knife bootstrap 10.0.1.2 -x vagrant -P vagrant --sudo -N df_box_elkstack --bootstrap-version 12.0.3 -r "recipe[df_java],recipe[df_elasticsearch],recipe[df_kibana],recipe[df_kibana::kibana_nginx],recipe[df_logstash],recipe[df_logstash::logstash_forwarder]"
</pre>
                <p>This cookbook is</p>
                <ul>
                  <li>installing elasticsearch, logstash, and kibana from packages</li>
                  <li>installing nginx to do a reverse proxy for the kibana UI</li>
                  <li>installing and configuring logstash-forwarder to output syslogs to logstash </li>
                  <li>logstash-forwarder is formatting the logs using regexp </li>
                </ul>
                <p><strong><u>Note1</u>: </strong>There have been some issues with package installation timing out
                  (logstash and java). You simply need to rerun the bootstrap command if it fails.</p>
                <p><strong><u>Note2</u>: </strong>There can be an issue on bootstrap if you already have entries for the
                  private ip addresses in your ~/.ssh/known_hosts file. If you receive an error similar to the following
                  on bootstrap, look to delete entries in your known_hosts file</p>
                <pre>

Connecting to 10.0.1.2
ERROR: Net::SSH::HostKeyMismatch: fingerprint 90:00:17:0e:a6:79:5a:0f:aa:97:ae:43:61:67:cb:07 does not match for "10.0.1.2"
</pre>
                <p>When you have successfully converged your node, simply type in 10.0.1.2 into your browser to verify
                  that everything is working.</p>
                <p><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-23%20at%209.19.21%20PM.jpg"
                    style="height:188px; width:300px" /></p>
                <p><em>(Kibana 4 general UI look. You can see the Time-field dropdown showing it is connected to
                    Logstash.) </em></p>
                <p> </p>
                <p>To see visualization, simply choose the @timestamp field in the timefield drop down, then click the
                  discover tab. there, you will see visualized logs of activity. </p>
                <p>Now that we know there is a working elkstack server, you will want to be able to upload it to the
                  Automate.Insights UI to take your existing infrastructure into a parsable format. Run</p>
                <pre>
knife topo export df_box_elkstack --topo elkstack &gt; elkstack.json
</pre>
                <p>This in turn</p>
                <ul>
                  <li>reads the node data from the chef-server</li>
                  <li>gives your node topology a name called elkstack</li>
                  <li>exports all the data into an Automate.Insights friendly json format. </li>
                </ul>
                <p>Once this is done you can upload it to the Automate.Insights server. </p>
                <p>First, Create a new business system. We will call this one df_elkblog. You can call it whatever you'd
                  like.</p>
                <p><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-27%20at%203.04.25%20PM.png"
                    style="height:136px; width:150px" /></p>
                <p><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-27%20at%203.04.39%20PM.jpg"
                    style="height:477px; width:250px" /></p>
                <p>Then, you will want to select that business system, and add a new blueprint</p>
                <p><img alt="" src="/_merged_assets/_static/images/07/import_blueprint_standalone.jpg"
                    style="height:225px; width:600px" /></p>
                <p>Next, click the prime topology from Chef, and load the json file that you just exported. </p>
                <p><img alt="" src="/_merged_assets/_static/images/07/load_topology_standalone.jpg"
                    style="height:309px; width:600px" /></p>
                <p>Going through the various loading options, you can make adjustments to your topology as you see fit,
                  including adding software type, node name, and attributes that you want available for adjustment.</p>
                <p><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-27%20at%203.06.21%20PM.jpg"
                    style="height:360px; width:700px" /></p>
                <p><em>(you have a chance to define which recipes make which software for a more human readable
                    format)</em></p>
                <p><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-27%20at%203.06.44%20PM.jpg"
                    style="height:361px; width:700px" /></p>
                <p><em>(selecting the node name is as straight forward as it gets. It's a nice feature)</em></p>
                <p><em><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-27%20at%203.07.08%20PM.jpg"
                      style="height:312px; width:600px" /></em></p>
                <p><em>(This page is for adjusting software versions. Our cookbooks are simplistic, and don't have this
                    as an option)</em></p>
                <p><em><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-27%20at%203.07.25%20PM.jpg"
                      style="height:366px; width:700px" /></em></p>
                <p><em>(It is wise to select which attributes you would want more immediate access to and which will
                    change quickly. you can search the ones you want very easily in the UI)</em></p>
                <p><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-27%20at%203.08.09%20PM.jpg"
                    style="height:363px; width:700px" /></p>
                <p><em>(example of completed field)</em></p>
                <p> </p>
                <p>Then voila, we have a software system that has a fully creatable runlist, with attributes, that you
                  can export back to chef when ready. To do so, input the host node that you intend to push this
                  topology to. </p>
                <p><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-07-23%20at%206.14.32%20PM.jpg"
                    style="height:296px; width:600px" /></p>
                <p><em>(Please note! I have the openSSL certs for the server specifically tied to 10.0.1.2 ip address.
                    If you do not pick that host IP, the TLS handshake will not work, and your installation will
                    fail)</em><img alt="" src="/_merged_assets/_static/images/07/export_standalone.jpg"
                    style="height:418px; line-height:1.6; width:800px" /></p>
                <p>Next, you will click export to Chef, and copy that to a json file in your dummy chef-repo. We decided
                  to name it elkstack_standalone.json</p>
                <p><img alt="" src="/_merged_assets/_static/images/07/Screen%20Shot%202015-08-03%20at%2012.26.51%20PM.png"
                    style="height:587px; width:400px" /></p>
                <p><em>(ignore cluster name, just a dummy image)</em></p>
                <p>Once that has downloaded, it is time to import your topology into a format that your chef-server can
                  work with. We have </p>
                <pre>
knife topo import elkstack.json
</pre>
                <p><strong>Note: </strong>I have stored a copy of a working topology file if yours somehow does not work
                  properly it is in topologies/elkstack_standalone.json if you just want to use that. </p>
                <p>Knife-Topo in the background will create </p>
                <ul>
                  <li>A topology data bag containing the topology data</li>
                  <li>A topology cookbook containing the node attributes </li>
                </ul>
                <p><img alt="" src="/_merged_assets/_static/images/07/topo_import_standalone.png"
                    style="height:89px; width:500px" /></p>
                <p>With a freshly created vagrant instance, now we can just run </p>
                <pre>
knife topo create elkstack --bootstrap --sudo -xvagrant -Pvagrant
</pre>
                <p><em>(<strong>Note: </strong>There have been some issues with logstash package installation timing
                    out. You simply need to rerun the last command and click when it prompts you to)</em></p>
                <p>And there you go. Using the topology cookbook we are able to spin up an exact version of the elkstack
                  server we already created. You can validate by following the previous steps in Kibana.</p>
                <p>For the next segment, we will be building on a more real world example with multiple nodes. Click <a
                    href="/content/automateinsights-part-3-practical-deep-dive-clustered">here</a> to jump to that tutorial.
                </p>
              </div>
            </div>
          </div>
          <footer>
          </footer>
        </article>
      </section>

    </div>
  </div>

  <footer class="footer container">
    <div class="region region-footer">
      <section id="block-block-2" class="block block-block clearfix">
        <hr />
        <p class="rtecenter">
          @devopsjeff
          <a href="mailto:pete@datafundamentals.com">pete@datafundamentals.com</a>
          @appwritercom
        </p>
        <hr />
        <p class="rtecenter">Copyright 2014, 2015 - dataFundamentals</p>
      </section>
    </div>
  </footer>
  
</body>

</html>